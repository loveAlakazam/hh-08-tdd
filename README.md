
![concurrency-db](./images/concurrency-db.png)

## ë™ì‹œì„±ì œì–´(concurrency control)

ë‹¤ì¤‘ ì‚¬ìš©ì í™˜ê²½ì„ ì§€ì›í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì‹œìŠ¤í…œì—ì„œ ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ë“¤ì´ ì„±ê³µì ìœ¼ë¡œ ë™ì‹œì— ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ê¸°ìˆ ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ê°„ì˜ ê°„ì„­ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ íŠ¸ëœì­ì…˜ì˜ ì‹¤í–‰ìˆœì„œë¥¼ ì œì–´í•˜ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤. ë™ì‹œì„±ì œì–´ëŠ” ì‹¤ìƒí™œì— ì‚¬ìš©ë˜ê³  ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì„œë¹„ìŠ¤ì—ì„œë„ ë§ì´ í™œìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.

- ê¸ˆìœµì„œë¹„ìŠ¤ì—ì„œ ê¸ˆì•¡ ì†¡ê¸ˆ/ì €ê¸ˆ
- ì‡¼í•‘ëª°ì„œë¹„ìŠ¤ì—ì„œ ì£¼ë¬¸ì²˜ë¦¬/ì¬ê³ ê°ì†Œ/ê²°ì œìš”ì²­
- ë™ì‹œ ì ‘ì†ììˆ˜ê°€ ë§ì€ ì‹¤ì‹œê°„ ì•±ì—ì„œ ì±„íŒ…/ëŒ“ê¸€/ì¢‹ì•„ìš” ìˆ˜ ì¦ê°€
- í¬ì¸íŠ¸ë‚˜, ìºì‹œë°±ì„ ì ë¦½/ì‚¬ìš©
- ì´ë²¤íŠ¸ ì‘ëª¨ì™€ ì„ ì°©ìˆœì¿ í° ë°œê¸‰

### ë™ì‹œì„±ì œì–´ë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ê¹Œ?

| ë¬¸ì œì                             | ì„¤ëª…                                                                                                                    |
| --------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| **ê°±ì‹ ë‚´ìš© ì†ì‹¤(lost update)**    | íŠ¸ëœì­ì…˜ë“¤ì´ ë™ì¼í•œ ë°ì´í„°ë¥¼ ë™ì‹œì— ê°±ì‹ í•˜ëŠ” ê²½ìš°ì— ë°œìƒí•©ë‹ˆë‹¤.                                                         |
|                                   | ì´ì „ íŠ¸ëœì­ì…˜ì´ ë°ì´í„°ë¥¼ ê°±ì‹ í•œ í›„ì— íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ê¸°ì „ì— ë‚˜ì¤‘ íŠ¸ëœì­ì…˜ì´ ê°±ì‹ ê°’ì„ ë®ì–´ì“°ëŠ” ê²½ìš°ì— ë°œìƒí•©ë‹ˆë‹¤.       |
| **í˜„í™©íŒŒì•… ì˜¤ë¥˜(dirty read)**     | íŠ¸ëœì­ì…˜ì˜ ì¤‘ê°„ ìˆ˜í–‰ê²°ê³¼ë¥¼ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì°¸ì¡°í•¨ìœ¼ë¡œì¨ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.                                              |
| **ëª¨ìˆœì„±(inconsistency)**         | ë‘ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì‹¤í–‰í•  ë•Œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¼ê´€ì„±ì´ ì—†ëŠ” ìƒíƒœë¡œ ë‚¨ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.                              |
| **ì—°ì‡„ë³µê·€ (cascading rollback)** | ë³µìˆ˜ì˜ íŠ¸ëœì­ì…˜ì´ ë°ì´í„° ê³µìœ ì‹œ íŠ¹ì • íŠ¸ëœì­ì…˜ì´ ì²˜ë¦¬ë¥¼ ì·¨ì†Œí• ë•Œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì²˜ë¦¬í•œ ë¶€ë¶„ì— ëŒ€í•œ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. |

### ë™ì‹œì„±ì œì–´ì—ëŠ” ì–´ë–¤ ì œì–´ê¸°ë²•ì´ ìˆì„ê¹Œ?

#### ì ê¸ˆ(locking)

![locking](./images/locking.png)

ì ê¸ˆ(locking)ì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ íŠ¹ì • ë°ì´í„° í•­ëª©ì— ëŒ€í•´ì„œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë™ì‹œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡í•œ ìƒí˜¸ë°°ì œ(mutual exclusive) ì…ë‹ˆë‹¤. í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì´ ë°ì´í„° í•­ëª©ì— ëŒ€í•´ì„œ ì ê¸ˆ(lock)ì„ ì„¤ì •í•˜ë©´ ì ê¸ˆì„ ì„¤ì •í•œ íŠ¸ëœì­ì…˜ì´ ì ê¸ˆí•´ì œ(unlock)í•  ë•Œê¹Œì§€ ë°ì´í„°ë¥¼ ë…ì ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì ê¸ˆ(lock)ì˜ ì¢…ë¥˜
  | ì¢…ë¥˜ | ì£¼ìš” ê°œë… |
  |---- | ---- |
  | ê³µìœ ë½(shared lock: S-lock)| ê³µìœ ì ê¸ˆí•œ íŠ¸ëœì­ì…˜ì€ ë°ì´í„° í•­ëª©ì— ëŒ€í•´ì„œ ì½ê¸°(read)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. |
  | | ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ë„ ì½ê¸°(read)ë§Œì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í˜•íƒœ ì…ë‹ˆë‹¤.|
  | ë°°íƒ€ë½(exclusive lock: X-lock)|ì „ì²´ì ê¸ˆí•œ íŠ¸ëœì­ì…˜ì€ ë°ì´í„° í•­ëª©ì— ëŒ€í•´ì„œ ì½ê¸°(read)ì™€ ì“°ê¸°(write) ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.|
  || ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ì½ê¸°(read)ì™€ ì“°ê¸°(write)ë¥¼ ëª¨ë‘ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.|

- ë¹„ê´€ì ë½(pessimistic lock)ê³¼ ë‚™ê´€ì ë½(optimistic lock)

- ì ê¸ˆì˜ ë‹¨ìœ„

![locking_unit](./images/locking-unit.png)

ì ê¸ˆì˜ ë‹¨ìœ„ëŠ” **ì ê¸ˆì˜ ëŒ€ìƒì´ ë˜ëŠ” ë°ì´í„° ê°ì²´ì˜ í¬ê¸°** ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
ì‘ê²ŒëŠ” ë ˆì½”ë“œì˜ í•„ë“œê°’, í•˜ë‚˜ì˜ ë ˆì½”ë“œ, ë¬¼ë¦¬ì  ì…ì¶œë ¥ ë‹¨ìœ„ê°€ ë˜ëŠ” ë””ìŠ¤í¬ë¸”ë¡ì´ ë  ìˆ˜ ìˆìœ¼ë©°, í¬ê²ŒëŠ” í…Œì´ë¸”ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ê¹Œì§€ í•˜ë‚˜ì˜ ì ê¸ˆì˜ ë‹¨ìœ„ê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì ê¸ˆì˜ ë‹¨ìœ„ê°€ í´ìˆ˜ë¡ ë™ì‹œì„±(ë³‘í–‰ì„±) ìˆ˜ì¤€ì€ ë‚®ì•„ì§€ê³ , ë™ì‹œì„± ì œì–´ê¸°ë²•ì€ ê°„ë‹¨í•´ì§‘ë‹ˆë‹¤.
ë°˜ë©´ì— ì ê¸ˆì˜ ë‹¨ìœ„ê°€ ì‘ì„ìˆ˜ë¡ ë™ì‹œì„±(ë³‘í–‰ì„±) ìˆ˜ì¤€ì€ ë†’ì•„ì§€ê³ , ë™ì‹œì„± ì œì–´ê¸°ë²• ê´€ë¦¬ëŠ” ë³µì¡í•´ì§‘ë‹ˆë‹¤.

ìƒí˜¸ë°°ì œì¸ ì ê¸ˆì€ êµì°©ìƒíƒœ(deadlock)ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### íƒ€ì„ìŠ¤íƒ¬í”„ ìˆœì„œ ê¸°ë²•

íŠ¸ëœì­ì…˜ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ DBMS ê°€ ë¶€ì—¬í•˜ëŠ” ìœ ì¼í•œ ì‹ë³„ìì¸ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì§€ì •í•˜ì—¬ íŠ¸ëœì­ì…˜ê°„ì˜ ìˆœì„œë¥¼ ë¯¸ë¦¬ì„ íƒí•˜ëŠ” ê¸°ë²•ì…ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œì— ë“¤ì–´ì˜¤ëŠ” íŠ¸ëœì­ì…˜ ìˆœì„œëŒ€ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì§€ì •í•˜ì—¬ ë™ì‹œì„± ì œì–´ì˜ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

---

## í”„ë¡œì„¸ìŠ¤ ë™ê¸°í™”

ë™ì‹œì„±ì œì–´ì—ëŠ” ìš´ì˜ì²´ì œ í”„ë¡œì„¸ìŠ¤ì˜ ìƒí˜¸ë°°ì œ ë™ê¸°í™” ê°œë…ë“¤ê³¼ ë§ì´ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ê·¸ë˜ì„œ ê´€ë ¨ìš©ì–´ì— ëŒ€í•´ ì „ê³µì„œì ì„ ì½ì–´ë³´ê³  ì •ë¦¬í•´ë´¤ìŠµë‹ˆë‹¤.

### ë™ê¸°í™”(synchronization)

- **í”„ë¡œì„¸ìŠ¤ë“¤ ì‚¬ì´ì˜ ìˆ˜í–‰ì‹œê¸°ë¥¼ ë§ì¶”ëŠ” ê²ƒ** ì„ ì˜ë¯¸í•˜ë©°, í”„ë¡œì„¸ìŠ¤ ë™ê¸°í™” ë¼ê³ ë„ ì •ì˜í•©ë‹ˆë‹¤. í”„ë¡œì„¸ìŠ¤ë“¤ ì‚¬ì´ì˜ ìˆ˜í–‰ì‹œê¸°ë¥¼ ë§ì¶˜ë‹¤ í•¨ì€ íŠ¹ì • ìì›ì— ì ‘ê·¼í• ë•Œ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì ‘ê·¼í•˜ê±°ë‚˜ í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜¬ë°”ë¥¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ë‘ê°€ì§€ë¥¼ ì¼ì»«ìŠµë‹ˆë‹¤.

- **ì‹¤í–‰ìˆœì„œì œì–´** ë¥¼ ìœ„í•œ ë™ê¸°í™”: ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜¬ë°”ë¥¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

- **ìƒí˜¸ë°°ì œ** ë¥¼ ìœ„í•œ ë™ê¸°í™”: ìƒí˜¸ë°°ì œëŠ” ê³µìœ ê°€ ë¶ˆê°€ëŠ¥í•œ ìì›, ë™ì‹œì— ì ‘ê·¼ì´ ì•ˆë˜ëŠ” ìì›ì„ ë™ì‹œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

### ê³µìœ ìì› ê³¼ ì„ê³„êµ¬ì—­ ê³¼ ë ˆì´ìŠ¤ì»¨ë””ì…˜

#### **ê³µìœ ìì›(shared resource)**

ê³µìœ ìì›ì€ **ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ê³µë™ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ìì›** ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì „ì—­ë³€ìˆ˜ê°€ ë  ìˆ˜ë„ ìˆê³ , íŒŒì¼ì´ ë  ìˆ˜ë„, ì…ì¶œë ¥ì¥ì¹˜, ë³´ì¡°ê¸°ì–µì¥ì¹˜ê°€ ë ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

#### **ì„ê³„êµ¬ì—­(critical section)**

ë‘ê°œ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ë©´ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì½”ë“œì˜ì—­ ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ë§Œì¼ ë‘ê°œ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„ êµ¬ì—­ì— ì§„ì…í•˜ê³ ì í•˜ë©´ ë‘˜ ì¤‘ í•˜ë‚˜ëŠ” ëŒ€ê¸°ë¥¼ í•´ì•¼í•©ë‹ˆë‹¤. ì„ê³„êµ¬ì—­ì— ë¨¼ì € ì§„ì…í•œ í”„ë¡œì„¸ìŠ¤ì˜ ì‘ì—…ì´ ë§ˆë¬´ë¦¬ë˜ë©´ ê·¸ì œì„œì•¼ ê¸°ë‹¤ë ¸ë˜ í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„êµ¬ì—­ì— ì§„ì…í•©ë‹ˆë‹¤.

#### **ë ˆì´ìŠ¤ì»¨ë””ì…˜(race condition)**

ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œë‹¤ë°œì ìœ¼ë¡œ ì„ê³„ êµ¬ì—­ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ì˜ ì¼ê´€ì„±ì´ ê¹¨ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ìƒí˜¸ë°°ì œë¥¼ ìœ„í•œ ë™ê¸°í™”ëŠ” ë‘ê°œì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„êµ¬ì—­ì—ì„œ ë™ì‹œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ê´€ë¦¬í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
ìš´ì˜ì²´ì œëŠ” ì´ëŸ¬í•œ ì„ê³„êµ¬ì—­ ë¬¸ì œë¥¼ ì•„ë˜ ì„¸ê°€ì§€ ì›ì¹™í•˜ì— í•´ê²°í•˜ë©° ìƒí˜¸ë°°ì œë¥¼ ìœ„í•œ ë™ê¸°í™”ë¥¼ ìœ„í•´ì„œëŠ” 3ê°€ì§€ ì›ì¹™ì´ ë°˜ë“œì‹œ ì§€ì¼œì ¸ì•¼í•©ë‹ˆë‹¤.

- (ì›ì¹™1) **ìƒí˜¸ë°°ì œ**: í•œ í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„êµ¬ì—­ì— ì§„ì…í–ˆë‹¤ë©´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ëŠ” ì„ê³„êµ¬ì—­ì— ë“¤ì–´ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- (ì›ì¹™2) **ì§„í–‰**: ì„ê³„êµ¬ì—­ì— ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë„ ì§„ì…í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ê³„êµ¬ì—­ì— ì§„ì…í•˜ê³ ìí•˜ëŠ” í”„ë¡œì„¸ìŠ¤ëŠ” ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ì•¼í•©ë‹ˆë‹¤.
- (ì›ì¹™3) **ìœ í•œëŒ€ê¸°**: í•œ í”„ë¡œì„¸ìŠ¤ê°€ ì„ê³„êµ¬ì—­ì— ì§„ì…í•˜ê³  ì‹¶ë‹¤ë©´ ê·¸ í”„ë¡œì„¸ìŠ¤ëŠ” ë¬´í•œëŒ€ê¸°ë¥¼ í•˜ì§€ì•Šê³  ì–¸ì  ê°€ëŠ” ì„ê³„êµ¬ì—­ì— ë“¤ì–´ì˜¬ ìˆ˜ ìˆì–´ì•¼í•©ë‹ˆë‹¤.

### ë®¤í…ìŠ¤ë½ (mutex)

ì„ê³„êµ¬ì—­ì„ ì ê¸ˆìœ¼ë¡œì¨ í”„ë¡œì„¸ìŠ¤ê°„ ìƒí˜¸ë°°ì œë¥¼ ì´ë£¨ëŠ” ë™ê¸°í™” ë„êµ¬ ì…ë‹ˆë‹¤.

![mutex](./images/mutex_lock_example.png)

> ì¼ìƒìƒí™œì—ì„œ íƒˆì˜ì‹¤/í™”ì¥ì‹¤ì´ ëŒ€í‘œì ì¸ ì˜ˆì…ë‹ˆë‹¤.
> ì•ì— ì¤„ì´ ì—†ê³  ë¹„ì–´ìˆë‹¤ë©´ ì‚¬ìš©ìëŠ” ë¹ˆ ì¥ì†Œì— ë“¤ì–´ê°€ì„œ íƒˆì˜ì‹¤/í™”ì¥ì‹¤ ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> ë°˜ëŒ€ë¡œ ì•ì— ì¤„ì´ ì„œìˆê±°ë‚˜ íƒˆì˜ì‹¤/í™”ì¥ì‹¤ì´ ìë¬¼ì‡ (ì ê¸ˆì¥ì¹˜)ë¡œ ì ê²¨ìˆë‹¤ë©´ ì•ì˜ ì‚¬ëŒì´ ë¨¼ì € ì´ìš©ì¤‘ì„ì„ íŒë‹¨í•˜ê³  ì•ì‚¬ëŒì´ ë‹¤í• ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼í•©ë‹ˆë‹¤.
>
> ì•ì˜ ì‚¬ëŒì´ ì ê¸ˆì„ í•´ì œí•˜ê³  ì—´ì‡ ë¥¼ ë°˜ë‚©í–ˆë‹¤ë©´, ì´ìš©ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ ì—´ì‡ ë¥¼ ê°€ì ¸ê°€ì„œ 'ì ê¸ˆ'ìƒíƒœë¡œí•˜ì—¬ ì´ìš©ì„ í•©ë‹ˆë‹¤. ì´ìš©ì„ ë‹¤í•˜ë©´ ì ê¸ˆì„ í•´ì œí•˜ê³  ì—´ì‡ ë¥¼ ë°˜ë‚©í•˜ì—¬ ë‚˜ì˜µë‹ˆë‹¤.
>
> - ì‚¬ëŒ/ì´ìš©ìëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
> - í™”ì¥ì‹¤/íƒˆì˜ì‹¤ì€ ì„ê³„êµ¬ì—­ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
> - ì—´ì‡ ëŠ” ë®¤í…ìŠ¤ ì…ë‹ˆë‹¤.

ìë¬¼ì‡ (ì ê¸ˆì¥ì¹˜)ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë®¤í…ìŠ¤ëŠ” ìƒí˜¸ë°°ì œë¥¼ ìœ„í•œ ë™ê¸°í™” ë„êµ¬ì…ë‹ˆë‹¤.
ë½ì„ íšë“í•  ìˆ˜ ì—†ë‹¤ë©´ í”„ë¡œì„¸ìŠ¤ëŠ” ì„ê³„êµ¬ì—­ì— ì§„ì…í•˜ì§€ ëª»í•œì±„ ë¬´ì‘ì • ê¸°ë‹¤ë¦¬ê³  ìˆì–´ì•¼í•˜ë©°, ë½ì„ íšë“í•  ìˆ˜ ìˆë‹¤ë©´ ì„ê³„êµ¬ì—­ì— ì§‘ì…í•˜ì—¬ ì ê·¼ë’¤ì— ì„ê³„êµ¬ì—­ì—ì„œ ì‘ì—…ì„ ì§„í–‰í•œë’¤ì— ì„ê³„êµ¬ì—­ì— ë¹ ì ¸ë‚˜ì™€ì„œ ì„ê³„êµ¬ì—­ì˜ ì ê¸ˆì„ í•´ì œí•©ë‹ˆë‹¤.

### ì„¸ë§ˆí¬ì–´ (semaphore)

![semaphore](./images/semaphore_example.png)

ì„¸ë§ˆí¬ì–´ëŠ” ê³µìœ ìì›ì´ ì—¬ëŸ¬ê°œ ìˆëŠ” ì„ê³„ êµ¬ì—­ ë¬¸ì œë„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë™ê¸°í™” ë„êµ¬ ì…ë‹ˆë‹¤.

ë®¤í…ìŠ¤ëŠ” í•˜ë‚˜ì˜ ê³µìœ ìì›ì— ì ‘ê·¼í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì •í•œ ë°©ì‹ì…ë‹ˆë‹¤. í™”ì¥ì‹¤/íƒˆì˜ì‹¤ 1ê°œë§Œ ìˆì„ ê²½ìš°ë¥¼ ê°€ì •í•´ì„œ ë§Œë“  ë™ê¸°í™” ë„êµ¬ì…ë‹ˆë‹¤.

í™”ì¥ì‹¤/íƒˆì˜ì‹¤ ì´ ì—¬ëŸ¬ê°œ ìˆì„ ê²½ìš°ì— ì—¬ëŸ¬ê°œì˜ í”„ë¡œì„¸ìŠ¤ê°€ ê°ê° ê³µìœ ìì›ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤. ë§Œì¼ í™”ì¥ì‹¤/íƒˆì˜ì‹¤ì´ 3ê°œê°€ ìˆì§€ë§Œ íƒˆì˜ì‹¤ 1ê°œë‹¹ í•œì‚¬ëŒì´ ì´ìš©í•  ìˆ˜ ìˆì§€ë§Œ 3ëª…ì´ ë™ì‹œì— í™”ì¥ì‹¤/íƒˆì˜ì‹¤ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## êµì°©ìƒíƒœ(deadlock)

í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ ìì›ì´ í•„ìš”í•œë° ë‘ ê°œì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ê°ì ê°€ì§€ê³  ìˆëŠ” ìì›ì„ ë¬´ì‘ì • ê¸°ë‹¤ë¦¬ê²Œë˜ë©´ êµì°©ìƒíƒœê°€ ë©ë‹ˆë‹¤.

ì‹ì‚¬í•˜ëŠ” ì² í•™ìë¬¸ì œ ëŠ” êµì°©ìƒíƒœë¥¼ ì„¤ëª…í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ë¬¸ì œìƒí™©ì…ë‹ˆë‹¤.

> ë™ê·¸ë€ ì›íƒì— ë‹¤ì„¯ëª…ì˜ ì² í•™ìê°€ ì•‰ì•„ìˆìŠµë‹ˆë‹¤.
> ì² í•™ìë“¤ ì•ì—ì„œëŠ” ë§›ìˆëŠ” ì‹ì‚¬ê°€ ìˆê³  ì² í•™ìë“¤ ì‚¬ì´ ì‚¬ì´ì—ëŠ” ì‹ì‚¬ì— í•„ìš”í•œ í¬í¬ê°€ ìˆìŠµë‹ˆë‹¤.
> ì² í•™ìë“¤ ì•ì— ìˆëŠ” ì‹ì‚¬ëŠ” ë‘ê°œì˜ í¬í¬ë¡œ ë¨¹ì„ ìˆ˜ ìˆëŠ” ìŒì‹ì´ë¼ ê°€ì •í•©ë‹ˆë‹¤.
> ëª¨ë“  ì² í•™ìê°€ ë™ì‹œì— í¬í¬ë¥¼ ì§‘ì–´ì„œ ì‹ì‚¬ë¥¼ í•˜ê²Œëœë‹¤ë©´ ì–´ë–¤ ì² í•™ìë„ ì‹ì‚¬ë¥¼ í•  ìˆ˜ ì—†ê³  ì˜ì›íˆ ìƒê°ë§Œ í•´ì•¼í•˜ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì² í•™ìê°€ í¬í¬ë¥¼ ë‚´ë ¤ë†“ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ”ê²ë‹ˆë‹¤.

**ì¼ì–´ë‚˜ì§€ ì•Šì„ ì‚¬ê±´ì„ ë¬´í•œíˆ ê¸°ë‹¤ë¦¬ë©° ì§„í–‰ì´ ë©ˆì¶°ë²„ë¦¬ëŠ” í˜„ìƒ**ì„ ë°ë“œë½ì´ë¼ê³  í•©ë‹ˆë‹¤.

### êµì°©ìƒíƒœ ë°œìƒì¡°ê±´

êµì°©ìƒíƒœê°€ ë°œìƒí•  ì¡°ê±´ì—ëŠ” 'ìƒí˜¸ë°°ì œ', 'ì ìœ ì™€ ëŒ€ê¸°', 'ë¹„ì„ ì ', 'ì›í˜•ëŒ€ê¸°' ë¡œ 4ê°€ì§€ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
ì•„ë˜ ì¡°ê±´ì¤‘ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ì§€ ì•Šë‹¤ë©´ êµì°©ìƒíƒœê°€ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ, ì•„ë˜ ì¡°ê±´ì¤‘ í•˜ë‚˜ë¥¼ ë§Œì¡±í•˜ê²Œ ë˜ë©´ êµì°©ìƒíƒœê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.

- **ìƒí˜¸ë°°ì œ(mutual exclusion)** : í”„ë¡œì„¸ìŠ¤ê°€ ì‚¬ìš©í•˜ëŠ” ìì›ì„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒì„ ì˜ë¯¸í•˜ë©°, ìì›ì„ ì‚¬ìš©í•˜ë ¤ë©´ 1ê°œì˜ í”„ë¡œì„¸ìŠ¤ë§Œì´ ì‚¬ìš©ê°€ëŠ¥í•˜ë©° ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ë“¤ì€ ì‘ì—…ì´ ì™„ìˆ˜í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼í•©ë‹ˆë‹¤.
- **ì ìœ ì™€ ëŒ€ê¸°(hold and wait)** : ì–´ë– í•œ ìì›ì„ í• ë‹¹ ë°›ì€ ìƒíƒœì—ì„œ ë‹¤ë¥¸ ìì›ì„ í• ë‹¹ ë°›ê¸°ë¥¼ ê¸°ë‹¤ë¦´ ê²½ìš°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
- **ë¹„ì„ ì (nonpreemetive)** : ë¹„ì„ ì  ìì›ì€ ê·¸ ìì›ì„ ì´ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ì‘ì—…ì´ ëë‚˜ì•¼ë§Œ ë¹„ë¡œì†Œ ì´ìš©ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë„ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì˜ ìì›ì„ ê°•ì œë¡œ ëºì§€ ëª»í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
- **ì›í˜•ëŒ€ê¸°(circular wait)** : í”„ë¡œì„¸ìŠ¤ë“¤ì´ ì›ì˜ í˜•íƒœë¡œ ìì›ì„ ëŒ€ê¸°í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

### êµì°©ìƒíƒœ í•´ê²°ë°©ë²•

- **êµì°©ìƒíƒœ ì˜ˆë°©** : í”„ë¡œì„¸ìŠ¤ë“¤ì— ìì›ì„ í• ë‹¹í•  ë•Œ, ìƒí˜¸ë°°ì œ/ì ìœ ì™€ ëŒ€ê¸°/ë¹„ì„ ì /ì›í˜•ëŒ€ê¸° ì¤‘ í•˜ë‚˜ì˜ ì¡°ê±´ì´ë¼ë„ ë§Œì¡±ì‹œí‚¤ì§€ì•Šê²Œ í• ë‹¹í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
- **êµì°©ìƒíƒœ íšŒí”¼** : êµì°©ìƒíƒœê°€ ë°œìƒí•˜ì§€ ì•Šì„ ì •ë„ë¡œë§Œ í”„ë¡œì„¸ìŠ¤ë“¤ì—ê²Œ ë°°ë¶„í•  ìˆ˜ ìˆëŠ” ìì›ì˜ ì–‘ì„ ê³ ë ¤í•˜ì—¬ ìì›ì„ í• ë‹¹ë°›ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
    - **ì•ˆì „ ìƒíƒœ** : êµì°©ìƒíƒœê°€ ë°œìƒí•˜ì§€ ì•Šê³  ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ìì›ì„ í• ë‹¹ë°›ê³  ì¢…ë£Œë  ìˆ˜ ìˆëŠ” ìƒíƒœ
    - **ë¶ˆì•ˆì „ ìƒíƒœ** : êµì°©ìƒíƒœê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìƒí™©
    - **ì•ˆì „ ìˆœì„œì—´** : êµì°©ìƒíƒœì—†ì´ ì•ˆì „í•˜ê²Œ í”„ë¡œì„¸ìŠ¤ë“¤ì— ìì›ì„ í• ë‹¹í•  ìˆ˜ ìˆëŠ” ìˆœì„œë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
- **êµì°©ìƒíƒœ ê²€ì¶œí›„ íšŒë³µ** : êµì°©ìƒíƒœ ë°œìƒì„ ì¸ì •í•˜ê³  ì‚¬í›„ì— ì¡°ì¹˜í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
    - **ì„ ì ì„ í†µí•œ íšŒë³µ** : êµì°© ìƒíƒœê°€ í•´ê²°ë  ë•Œê¹Œì§€ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ë¡œë¶€í„° ìì›ì„ ê°•ì œë¡œ ëºê³ , í•œê°œì˜ í”„ë¡œì„¸ìŠ¤ì”© ìì›ì„ ëª°ì•„ì£¼ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ìì›ì„ ëºê²¨ë²„ë ¤ì„œ í”„ë¡œì„¸ìŠ¤ë“¤ì˜ ì‘ì—…ë‚´ì—­ì„ ìƒì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.
    - **í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œë¥¼ í†µí•© íšŒë³µ** : í”„ë¡œì„¸ìŠ¤ë¥¼ ëª¨ë‘ ê°•ì œì¢…ë£Œí•˜ê±°ë‚˜ êµì°©ìƒíƒœê°€ ì—†ì–´ì§ˆ ë•Œê¹Œì§€ í•œê°œì˜ í”„ë¡œì„¸ìŠ¤ì”© ê°•ì œë¡œ ì¢…ë£Œí•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ êµì°© ìƒíƒœê°€ ì—†ì–´ì¡ŒëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë²„í—¤ë“œë¥¼ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## Java ì–¸ì–´ì—ì„œì˜ ë™ì‹œì„±ì œì–´ ë°©ì‹ì€ ì–´ë–¤ê²Œ ìˆì„ê¹Œ?

| ë²”ì£¼                        | ë°©ë²•                                   | ì„¤ëª…                                                                                                             |
| --------------------------- | -------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | --- |
| JVM ë ˆë²¨                    | `synchronized`, `ReentrantLock`        | í•œ JVM ë‚´ì—ì„œë§Œ ìœ íš¨í•œ ë½ì´ë©°, ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œëŠ” ë¬´ì˜ë¯¸í•˜ë‹¤.                                              |     |
|                             | JVM ë‚´ íê¸°ë°˜ ì²˜ë¦¬ `ConcurrentHashMap` | ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ ì§ë ¬í™” ì „ëµìœ¼ë¡œ ì—¬ëŸ¬ìš”ì²­ì´ í•œë²ˆì— ì™€ë„ ê° ìš”ì²­ì„ íì— ë„£ê³  í•˜ë‚˜ì”© ì²˜ë¦¬í•œë‹¤.                   |
| DB ë ˆë²¨                     | ë¹„ê´€ì ë½(Pessimistic Lock)             | ì¡°íšŒì‹œ ë½ì„ ê±¸ê³  ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì„ ì°¨ë‹¨í•˜ì—¬ ë°ì´í„°ì¶©ëŒì„ ë¯¸ì—°ì— ë°©ì§€í•œë‹¤. ë°ë“œë½ì´ ë°œìƒí•˜ì—¬ ì„±ëŠ¥ì €í•˜ê°€ ì˜¬ ìˆ˜ ìˆë‹¤. |
|                             |                                        | `@Lock(LockModeType.PESSIMISTIC_WRITE)`                                                                          |
|                             | ë‚™ê´€ì ë½(Optimistic Lock)              | ì¶©ëŒê°€ëŠ¥ì„±ì„ ê°ì•ˆí•˜ê³  ìˆ˜ì •í•˜ë©°, ì¶©ëŒì´ ë°œìƒí•˜ë©´ ë¡¤ë°±í•œë‹¤                                                         |
| ë¶„ì‚°í™˜ê²½                    | Redisson, Redis Lock, Zookeeper ë“±     | ë¶„ì‚°ë½ êµ¬í˜„ ê°€ëŠ¥. ë©€í‹°ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œ ë½ê³µìœ ê°€ ê°€ëŠ¥í•˜ë‹¤.                                                       |
| ë¹„ë™ê¸°ì‹ ì§ë ¬í™” íê¸°ë°˜ ì²˜ë¦¬ | Kafka, RabbitMQ ë“±ìœ¼ë¡œ ì§ë ¬í™” ì²˜ë¦¬     | ë¹„ë™ê¸°ì‹ ì§ë ¬í™” ë°©ì‹                                                                                             |

- ì§ë ¬í™”(serialization): ê°ì²´ì˜ ìƒíƒœë¥¼ ë°”ì´íŠ¸ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ íŒŒì¼ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì „ì†¡í•  ìˆ˜ ìˆê²Œí•˜ëŠ” ê³¼ì •ì´ë©°, ë¶„ì‚°ì‹œìŠ¤í…œì—ì„œë„ ê°ì²´ì˜ ìƒíƒœë¥¼ ì „ì†¡í•˜ê³  ìˆ˜ì‹ ìì¸¡ì—ì„œëŠ” ì´ë¥¼ ë‹¤ì‹œ ê°ì²´ë¡œ ë³µì›í•˜ì—¬(ì—­ì§ë ¬í™”)í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ì–´ë–»ê²Œ ì„œë¹„ìŠ¤ì—ì„œ ë™ì‹œì„±ì œì–´ë¥¼ ì ìš©í•´ì•¼í• ê¹Œ?

> ë¯¸ì…˜ ìƒí™©: ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— í¬ì¸íŠ¸ë¥¼ ì¶©ì „í•  ê²½ìš° í•´ë‹¹ìš”ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼í•©ë‹ˆë‹¤.

JVM ë‚´ì—ì„œ ë™ì‹œì„±í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë ¤ê³ í•œë‹¤ë©´, synchornized, ReentrantLock, JVM ë‚´ í(queue)ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë™ì‹œì„±ì œì–´ë¥¼ í…ŒìŠ¤íŠ¸í• ë•Œ í†µí•©í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰í•´ì•¼ë˜ëŠ”ê±´ì§€ ì•„ë‹ˆë©´ ìœ ë‹›í…ŒìŠ¤íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ì•¼ë ì§€ ì• ë§¤í• ê²ë‹ˆë‹¤.

ë‹¨ìœ„í…ŒìŠ¤íŠ¸ëŠ” ê°€ì¥ ì‘ì€ í…ŒìŠ¤íŠ¸ì¸ë§Œí¼ 1ê°œ ë©”ì„œë“œ/í•¨ìˆ˜ ë‹¨ìœ„ë¡œ ë…ë¦½ì ì¸ ê¸°ëŠ¥ì„ ë¹ ë¥´ê²Œ ê²€ì¦í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.
ë™ì‹œìš”ì²­ì´ ë°œìƒí•  ë•Œ íë¥¼ ì´ìš©í•´ì„œ ìˆœì„œë¥¼ ì œê³µí•´ì£¼ê±°ë‚˜ ì ê¸ˆ(locking)ì—°ì‚°ì„ ìˆ˜í–‰í•˜ì—¬ ë‹¤ë¥¸ìš”ì²­ì´ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ë§‰ê±°ë‚˜, íë¥¼ ì´ìš©í•´ì„œ ìˆœì„œë¥¼ ë³´ì¥í•´ì¤˜ì•¼í•˜ëŠ” ì—­í• ê¹Œì§€ ê²€ì¦ì„ í•´ì•¼ë˜ê¸° ë•Œë¬¸ì— ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë§Œìœ¼ë¡œëŠ” ì–´ë ¤ìš¸ê±°ê°™ìŠµë‹ˆë‹¤.

ì¦‰, ë™ì‹œì„±ì€ ì—¬ëŸ¬ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ê±°ë‚˜ ì‹¤í–‰ë  ë•Œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ ê²€ì¦í•´ì•¼í•˜ë¯€ë¡œ, ë‹¨ì¼ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë§Œìœ¼ë¡œëŠ” ë™ì‹œì ì¸ ìƒí™©ì„ ì¬í˜„í•˜ê¸°ê°€ ì–´ë µìŠµë‹ˆë‹¤. **ë”°ë¼ì„œ ë™ì‹œì„±ì„ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ í†µí•©í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦** í•´ì•¼ë©ë‹ˆë‹¤.

### synchronized í™œìš©í•˜ê¸°

- `synchronized`ëŠ” í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì„ê³„ì˜ì—­(critical section)ì— ì ‘ê·¼í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” í‚¤ì›Œë“œë¡œ, ê³µìœ ìì›ì— ëŒ€í•œ ë™ì‹œì ‘ê·¼ì„ ì°¨ë‹¨í•˜ì—¬ Race Conditionì„ ë°©ì§€í•©ë‹ˆë‹¤.

> ìœ ì €í¬ì¸íŠ¸ ID(id) ë§ˆë‹¤ ë½ì„ ê´€ë¦¬ - ConcurrentHashMap ìœ¼ë¡œ ë¶„ë¦¬ëœ ë½ë“¤ì„ ê´€ë¦¬

```java
@Component
public class UserPointLockManager {
	// ì‚¬ìš©ìë³„ ë¶„ë¦¬ëœ ë½ì„ ê´€ë¦¬í•˜ëŠ” ë§µ
	// 1. ì‚¬ìš©ì ID(id) ë§ˆë‹¤ í•˜ë‚˜ì˜ ê³ ìœ í•œ ë½(Object)ë¥¼ ì €ì¥í•˜ëŠ” ë§µ
	// 2. synchronizedì— ë„˜ê¸¸ ë½ì„ í•˜ë‚˜ë§Œ ì“°ë©´ ì „ì—­ë½(exclusive lock)ì´ ë˜ë¯€ë¡œ ì‚¬ìš©ìë³„ë¡œ ë¶„ë¦¬ëœ ë½ê°ì²´ë¥¼ ê´€ë¦¬
	private final ConcurrentHashMap<Long, Object> locks = new ConcurrentHashMap<>();

	// getLock: ì‚¬ìš©ì ID(id)ì— í•´ë‹¹í•˜ëŠ” ë½(lock)ì„ íšë“.
	public Object getLock(Long id) {
		// locks.computeIfAbsent(id, key -> new Object());
		// 1. ì‚¬ìš©ì ID(id)ì— í•´ë‹¹í•˜ëŠ” ë½ê°ì²´ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ ê°ì²´ë¥¼ ë°˜í™˜í•˜ê³ , ì—†ë‹¤ë©´ ìƒˆë¡œìš´ ë½ì„ ë„£ëŠ”ë‹¤.
		// 2. ì‚¬ìš©ì ID(id)ë³„ í•˜ë‚˜ì˜ ê³ ìœ í•œ ë½ì„ í•„ìš”í•  ë•Œë§Œ ë§Œë“¤ê³  ì¤‘ë³µìœ¼ë¡œ ë§Œë“¤ì§€ì•Šë„ë¡ ë³´ì¥í•œë‹¤.
		return locks.computeIfAbsent(id, key -> new Object());
	}
}
```

> ì¶©ì „ ì„œë¹„ìŠ¤ ë‚´ë¶€ë¡œì§ì— synchronized ë¸”ë¡ì„ ì¶”ê°€í•˜ì—¬ ì„ê³„êµ¬ì—­ ë¸”ë¡ ì§€ì •í•˜ê¸°

```java
@RequiredArgsConstructor
public class PointServiceImpl implements PointService {

	private final UserPointRepository userPointRepository;
	private final PointHistoryRepository pointHistoryRepository;
	private final UserPointLockManager userPointLockManager;
	private static final Logger log = LoggerFactory.getLogger(PointServiceImpl.class);

  ...

@Override
	public ChargeResponse charge(ChargeRequest request) {
		long id = request.id();
		long amount = request.amount();

		// synchronized ì˜ˆì•½ì–´ë¥¼ ë¶™ì¸ ë¸”ë¡ì€ ì„ê³„ì˜ì—­ìœ¼ë¡œ : ìœ ì €í¬ì¸íŠ¸ ID(id)ì˜ lockì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ìš”ì²­ì˜ ì ‘ê·¼ì„ ì œí•œí•œë‹¤.
		synchronized (userPointLockManager.getLock(id)){
			// ë¡œê·¸ê¸°ë¡
			log.info("::: ğŸ”’ Lock acquired for userId: {}, thread: {}", id, Thread.currentThread().getName());

			UserPoint userPoint = this.userPointRepository.findById(id);
			long myPoint = userPoint.point();

			// í¬ì¸íŠ¸ë‚´ì—­ì— 'ì¶©ì „' ê¸°ë¡
			this.pointHistoryRepository.insert(id, amount, TransactionType.CHARGE);

			// í¬ì¸íŠ¸ ì¶©ì „
			UserPoint result = this.userPointRepository.save(id, myPoint + amount);
			return ChargeResponse.from(result);
		}
	}
}
```

### ReentrantLock í™œìš©í•˜ê¸°

`ReentrantLock`ì€ ë™ì¼í•œ ì“°ë ˆë“œê°€ ì—¬ëŸ¬ë²ˆ ë½ì„ íšë“í•  ìˆ˜ ìˆëŠ” ì¬ì§„ì…ì´ ê°€ëŠ¥í•œ ë½ìœ¼ë¡œ `synchronized` ë³´ë‹¤ ë” ì •ë°€í•œ ë½ì œì–´ì™€ ë½ í™•ì¸ ìƒíƒœ, íƒ€ì„ì•„ì›ƒ, ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬ë“±ì´ ê°€ëŠ¥í•œ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ë˜í•œ `ReentrantLock`ì€ ì‹¤ì‹œê°„ ì œì–´, deadlock íšŒí”¼, ë½ ìƒíƒœ ì§„ë‹¨ ë“± ê³ ê¸‰ì œì–´ê°€ í•„ìš”í•  ë•Œ ì í•©í•©ë‹ˆë‹¤.

> ìœ ì €í¬ì¸íŠ¸ ID(id) ë§ˆë‹¤ ë½ì„ ê´€ë¦¬ - ConcurrentHashMap ìœ¼ë¡œ ë¶„ë¦¬ëœ ë½ë“¤ì„ ê´€ë¦¬

```java
@Component
public class UserPointLockManager {
	private final ConcurrentHashMap<Long, ReentrantLock> locks = new ConcurrentHashMap<>();

	public ReentrantLock getLock(long id) {
		return locks.computeIfAbsent(id, key -> new ReentrantLock());
	}
}
```

> ì¶©ì „ ì„œë¹„ìŠ¤ ë‚´ë¶€ë¡œì§ì— tryë¸”ë¡ì„ ì„ê³„êµ¬ì—­ ë¸”ë¡ ì§€ì •í•˜ê³ 
> ì„ê³„êµ¬ì—­ ì…êµ¬ì—ëŠ” `lock.lock()`ì€ ì ê¸ˆìƒíƒœì¸ì§€(ì´ë¯¸ ìš”ì²­ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³ ìˆëŠ” ì¤‘ì¸ì§€) ì•„ë‹Œì§€ë¥¼ í™•ì¸í•˜ê³ , ì ê²¨ìˆë‹¤ë©´ ëë‚ ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼í•œë‹¤. ë°˜ëŒ€ë¡œ ì—´ë ¤ìˆëŠ” ìƒíƒœë¼ë©´ ì„ê³„ì˜ì—­ì— ì§„ì…í•˜ì—¬ ì ê·¼ë‹¤.
> ì‘ì—…ê²°ê³¼ì— ìƒê´€ì—†ì´ ìš”ì²­ì‘ì—… ìˆ˜í–‰ì´ ì™„ë£Œë˜ë©´ `lock.unlock()`ìœ¼ë¡œ ì ê¸ˆì„ í•´ì œí•œë‹¤

```java
@Service
@RequiredArgsConstructor
public class PointServiceImpl implements PointService {

	private final UserPointRepository userPointRepository;
	private final PointHistoryRepository pointHistoryRepository;
	private static final Logger log = LoggerFactory.getLogger(PointServiceImpl.class);
	private final UserPointLockManager userPointLockManager;

	@Override
	public ChargeResponse charge(ChargeRequest request) {
		long id = request.id();
		long amount = request.amount();

		ReentrantLock lock = userPointLockManager.getLock(id);
		lock.lock(); // ë½ íšë“í•˜ì—¬ ë‹¤ë¥¸ìš”ì²­ì´ ë“¤ì–´ì˜¤ì§€ ëª»í•˜ë„ë¡ ì„ê³„êµ¬ì—­ì„ ì ê¸ˆ
		try{
			// try ë¸”ë¡ì•ˆì€ ì„ê³„êµ¬ì—­ ì´ë¯€ë¡œ, í•˜ë‚˜ì˜ ìš”ì²­ì´ ì‘ì—…ì„ ìˆ˜í–‰
			log.info("::: ğŸ”’ Lock acquired for userId: {}, thread: {}", id, Thread.currentThread().getName());
			UserPoint userPoint = this.userPointRepository.findById(id);
			long myPoint = userPoint.point();

			this.pointHistoryRepository.insert(id, amount, TransactionType.CHARGE); // í¬ì¸íŠ¸ë‚´ì—­ì— 'ì¶©ì „' ê¸°ë¡
			UserPoint result = this.userPointRepository.save(id, myPoint + amount); // í¬ì¸íŠ¸ ì¶©ì „
			return ChargeResponse.from(result);
		} finally {
			lock.unlock(); // ë½ì„ ë°˜í™˜í•˜ì—¬ ì„ê³„êµ¬ì—­ì„ ì ê¸ˆí•´ì œ
		}
	}
}
```

### (ê³µí†µ) ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì½”ë“œ

```java
@SpringBootTest
@AutoConfigureMockMvc
@TestInstance(TestInstance.Lifecycle.PER_CLASS) // ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ 
public class ChargeConcurrencyTest {
 @Autowired
 private MockMvc mockMvc;

 @Autowired
 private PointService pointService;

 @Autowired
 private UserPointRepository userPointRepository;

 @Autowired
 private PointHistoryRepository pointHistoryRepository;

 @Autowired
 private ObjectMapper objectMapper;

 @Autowired
 private UserPointLockManager userPointLockManager;


 @BeforeEach
 void setUp() {
  // UserPoint ì˜ ì´ˆê¸° í¬ì¸íŠ¸ê°’ì„ 0 ìœ¼ë¡œí•œë‹¤.
  userPointRepository.save(1L, 0L);
 }

@Test
 void ë™ì‹œì—_100ë²ˆ_ì¶©ì „ìš”ì²­ì„_ìš”ì²­í–ˆì„ë•Œ_ì •ìƒì ìœ¼ë¡œ_í•©ì‚°ì—_ì„±ê³µí•´ì•¼í•œë‹¤() throws Exception {
  // given
  long id = 1L;
  int threadCount = 100;
  long chargeAmount = 1000L;

  ExecutorService executor = Executors.newFixedThreadPool(10); // ìŠ¤ë ˆë“œí’€ 10ê°œ
  CountDownLatch latch = new CountDownLatch(threadCount); // ìš”ì²­ê°€ëŠ¥í•œ ìŠ¤ë ˆë“œê°œìˆ˜
  ChargeRequestBody requestBody = new ChargeRequestBody(chargeAmount);
  String json = objectMapper.writeValueAsString(requestBody);

  // when
  for(int i = 0 ; i < threadCount ; i++) {
   executor.submit(()-> {
    try {
      // ì¶©ì „ API í˜¸ì¶œ
     mockMvc.perform(patch("/point/"+id+"/charge")
      .contentType(MediaType.APPLICATION_JSON)
      .content(json));
    } catch (Exception e) {
     e.printStackTrace();
     throw new RuntimeException(e);
    } finally {
     latch.countDown(); // ìš”ì²­ê°€ëŠ¥ ìŠ¤ë ˆë“œ ê°œìˆ˜ ê°ì†Œ
    }
   });
  }

  latch.await(); // ë‹¤ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
  Thread.sleep(1000); // 1ì´ˆ ì •ë„ ëŒ€ê¸°í›„ ìµœì¢… í¬ì¸íŠ¸ í™•ì¸

  // then
  long expectedPoint = chargeAmount * threadCount;
  long finalPoint = userPointRepository.findById(id).point();
  assertEquals(expectedPoint, finalPoint);
 }
}
```

---

## ê²°ë¡ 

- í˜„ì¬ synchronized, ReentrantLock ë“± JVMë‚´ì—ì„œë§Œ í™œìš©ë˜ëŠ” ë½ì´ë©° í•˜ë‚˜ì˜ ì„œë²„ì—ì„œëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.
- synchronized ì€ ì„ê³„êµ¬ì—­ì„ ë¸”ë¡ìœ¼ë¡œ ì§€ì •í•˜ì—¬ ë‚˜íƒ€ë‚´ì§€ë§Œ ë‹¨ìˆœí•˜ê²Œ ë™ì‹œì„±ì œì–´ë¥¼ ì²˜ë¦¬í•˜ëŠ”ë° ì¢‹ìŠµë‹ˆë‹¤.
- ReentrantLock ì€ ì„ê³„êµ¬ì—­ì„ ì§„ì…í•˜ê¸°ì „ì—ëŠ” lockë¥¼ ì„ê³„êµ¬ì—­ì„ ë¹ ì ¸ë‚˜ì˜¤ë©´ unlock ìœ¼ë¡œ ëª…ì‹œí•˜ì—¬ synchronized ë³´ë‹¤ëŠ” ì •êµí•˜ê²Œ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
- ë™ì‹œì„±ì œì–´ì™€ ê´€ë ¨ëœ í…ŒìŠ¤íŒ…ì€ ì‘ì„±í•  ë•ŒëŠ” ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë³´ë‹¤ í†µí•©í…ŒìŠ¤íŠ¸ê°€ ì í•©í•©ë‹ˆë‹¤.
- ì„ ì…ì„ ì¶œ ìë£Œêµ¬ì¡°ì¸ í(queue)ë¥¼ ì´ìš©í•´ì„œ ë™ì‹œì„±ì œì–´ ë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ Lockë‹¤ë¥´ê²Œ ì—¬ëŸ¬ ìš”ì²­ì´ í•œë²ˆì— ë“¤ì–´ì™€ë„ ê° ìš”ì²­ì„ íì—ë„£ê³  ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ”ë°©ì‹ì…ë‹ˆë‹¤. ì˜¤íˆë ¤ ë™ì‹œì„±ì´ìŠˆë¥¼ ì œê±°ì‹œì¼œì„œ í•´ê²°í•˜ëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤.

### ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ë³´ë©´ì„œ ëŠë‚€ì 

ë™ì‹œì„± ì œì–´ì™€ ê·¸ì™€ ê´€ë ¨ëœ ìš´ì˜ì²´ì œ ê°œë…ë“¤ì„ ì •ë¦¬ë¥¼ ì´í•´í•˜ê³ ë‚˜ì„œ ë™ì‹œì„±ì œì–´ì— ëŒ€í•œ ìë£Œì¡°ì‚¬ ì•„í‹°í´ë“¤ì„ ì½ì–´ë³´ë‹ˆ ì¡°ê¸ˆì”© ì •ë¦¬ê°€ ë˜ëŠ”ê±° ê°™ì•˜ìŠµë‹ˆë‹¤. ì™œ ë” ê¸°ë³¸ê¸°ë¥¼ ì¤‘ìš”í•˜ë‹¤ê³  í•˜ëŠ”ê²Œ ëª¸ìœ¼ë¡œ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ì´ Lockì„ ì´ìš©í•œ ë™ì‹œì„±ì œì–´ë¥¼ ê¹Šê²Œ ë‹¤ë£°í…ë°, ì—¬ê¸°ì„œ ë” í™•ì¥ëœ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œì˜ ë½, Redisì˜ ë¶„ì‚°ë½, Kafkaì™€ RabbitMQì™€ ê°™ì€ ë¹„ë™ê¸°ì‹ íë¥¼ ì´ìš©í•œ ì§ë ¬í™”ì— ëŒ€í•œ ì•„í‹°í´ë“¤ì„ ì½ì–´ë³´ê³ ì‹¶ìŠµë‹ˆë‹¤.

## ì°¸ê³ ìë£Œ

- (ë„ì„œ) í˜¼ìê³µë¶€í•˜ëŠ” ì»´í“¨í„°êµ¬ì¡°+ìš´ì˜ì²´ì œ
- [ë™ì‹œì„± ì œì–´ DB ìš´ì˜](https://i-bada.blogspot.com/2012/04/db_24.html)
- [ë™ì‹œì„± ì œì–´ ê°œìš”](http://www.jidum.com/jidums/view.do?jidumId=282)
- [ë™ì‹œì„± ì œì–´ ê¸°ë²• ì ê¸ˆ locking ê¸°ë²•](https://medium.com/pocs/%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%A0%9C%EC%96%B4-%EA%B8%B0%EB%B2%95-%EC%9E%A0%EA%B8%88-locking-%EA%B8%B0%EB%B2%95-319bd0e6a68a)
